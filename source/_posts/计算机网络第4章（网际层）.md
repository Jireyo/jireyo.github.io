---
title: 计算机网络第4章（网际层）
categories:
 - [八股,计算机网络,基础]
date: 2022-12-14 20:48:03
tag: 
 - 计算机网络
 - 八股
---
# 一、概述
- 网络层的主要任务是**实现网络互连**，进而**实现数据包在各网络之间的传输**
- 为了实现这个任务，有以下问题：
	- 网络层提供可靠传输还是不可靠传输
	- 网络层怎么寻址(IP地址做导航)
	- 网络层路由选择(路由器根据路由表转发，为了记录路由需要人工配置或实现各种路由选择协议)


>网络层（网际层）,除了**IP协议**外，还有之前介绍过的**地址解析协议ARP**，还有**网际控制报文协议ICMP**，**网际组管理协议IGMP**

>由于TCP/IP协议栈的网络层使用网际协议IP，因此在TCP/IP协议中网络层常称为网际层。

{% note primary %}
- 数据链路层能通过MAC地址与交换机实现数据的定向传输，但是对于庞大的因特网，这显然是不合理的，相比起MAC地址的无序序列，我们需要一个具有明显层级关系的地址（如湖北省武汉市洪山区）方便快速定位，统一管理，因此有了IP地址。
- 网络层需要实现数据在局域网和局域网之间的传递（不同于之前的局域网通过交换机互联，这样会扩大广播域，VLAN虽然能实现类似的功能，但依赖于用户设置，无法达到全网统一）。
{% endnote %}

# 二、网络层提供的服务
网络层应该向运输层提供怎样的服务（“**面向连接**”还是“**无连接**”），实质就是**在计算机通信中，可靠交付应当由网络还是端系统来负责**？

- 第一种观点是**网络提供虚电路连接**（一种使用**面向连接**的通信方式，通信之前先建立**虚电路**，保证所有网络资源，分组即可按顺序无差错的到达），由网络本身负责可靠交付。
- 另一种观点是**网络只提供数据报服务**，向上只提供简单灵活的、**无连接的**、**尽最大努力交付**的**数据报服务**。由网络的**主机中的运输层负责可靠交付（包括差错处理、流量控制等）**。

>显然后者是我们现在使用的，其运行灵活，造价低，适应性强。
>
>**区别**
>终点地址：
>1.仅在连接建立阶段使用，每个分组使用短的虚电路号
>2.每个分组都有终点的完整地址
>
>当结点出故障时：
>1.所有通过出故障的结点的虚电路均不能工作
>2.出故障的结点可能会丢失分组，一些路由可能会发生变化
>
>端到端的差错处理和流量控制：
>1.可以由网络负责，也可以由用户主机负责
>2.由用户主机负责

{% note primary %}
当前网络层的服务实现是：**尽最大努力交付**。
{% endnote %}

# 三、IPv4
**IPv4地址**是因特网（*Internet*）上每一个主机（或路由器）的每一个接口分配一个在全世界范围内是唯一的32bit（4个字节）的标识符。

{% note warning %}
只有**公网IP**是全世界独一无二的，**私网IP**是在不同局域网中可以重复使用的：
RFC1918定义了私有IP的地址范围：
A:10.0.0.0 ~ 10.255.255.255即10.0.0.0/8
B:172.16.0.0 ~ 172.31.255.255即172.16.0.0/12
C:192.168.0.0 ~ 192.168.255.255 即192.168.0.0/16
{% endnote %}

{% note success %}
**私有IP是无法随意定义的**，只有以上范围内的IP会被路由器视为内网IP，以这些IP为源IP的数据包只会在局域网内传递，不会在因特网上传递。

私有IP设备**发送**与**接受**外网数据包：
首先内网中的客户端将数据包传送给路由器，路由器解析数据包后发现，这个数据包是来自与私网、发送给外网的。例如某个数据包的源IP:192.168.1.2，当路由器检测到这个数据包的目标IP是外网IP的时候，路由器中会生成一个唯一端口号对应192.168.1.2，再生成一个随机端口号对应这个唯一端口号。然后路由器会将数据包的源IP改成公网IP，发送到互联网上。接收数据时，数据包会被发送到路由器的随机端口号上，这时和原来生成的映射表进行匹配，再把数据包传送到内网客户端，其实就是一个端口映射表。
[路由器修改报文端口号](https://blog.csdn.net/weixin_39661353/article/details/110806482)
{% endnote %}

IPv4的编址方法经历了3个阶段：
**分类编址 -> 划分子网 -> 无分类编址**

## 分类编址
![](24878825-617a75508f564e07.webp)
其中有2个网络号无法分配，即A类地址：
- **最小网络号为0，保留不做指派**
- **最大网络号为127，是本地回环测试地址，保留不做指派**

有2类主机号无法分配：
- 全0的主机号，其表示该网络的标识地址
- 全1的主机号，其表示该网络的广播地址

{% note primary %}
网络号，主机号都为0，即`0.0.0.0`，表示本网络上的本主机（见DHCP协议）
{% endnote %}

>- **实际上 IP 地址是标志一个主机（或路由器）和一条链路的接口**。
>	- 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为**多归属主机** (multihomed host)。
>	- 由于一个路由器至少应当连接到两个网络（这样它才能将 IP 数据报从一个网络转发到另一个网络），因此**一个路由器至少应当有两个不同的 IP 地址**。
>- **用转发器或网桥连接起来的若干个局域网仍为一个网络**

## 划分子网的IPv4地址
两级的IP地址会导致IP地址空间的利用率很低。
子网即从主机号借一部分作为子网号，从而将一个网络号分为多个子网。
![](24878825-5006c8be601f1a11.webp)
划分子网的工具即**子网掩码**。
其将**两级的IP地址**变成了**三级的IP地址**。

**默认子网掩码**
![](24878825-5e9d1b71bd598e62.webp)

IPv4地址与子网掩码相与即得到所在子网的网络地址。

>对于在因特网上传输的数据报，仍然是根据**目的网络号**net-id寻找下一跳路由器。到了该网络号的路由器时，路由器再根据**目的网络号** net-id 和**子网号** subnet-id 找到目的子网。

{% note primary %}
**划分子网纯属一个单位内部的事情，对外部网络透明**，对外仍然表现为没有划分子网的一个网络。
这里所谈论的**划分子网**针对的仍然是因特网上的IP地址，其并没有造成IP地址重复（`相同的ip/不同的子网掩码`指的仍是同一个主机），只是单位内部对于可分配的主机号进行的一种再划分，即：
- 子网掩码对于外网路由器没有作用。
- 内网路由器根据接受到的IP匹配对于的子网，能实现对该子网更精准的路由。
（最长前缀匹配）
{% endnote %}

>- 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器。
>- 路由器的路由表中的每一个记录，除了要记载目的网络地址外，还必须同时记载该网络的子网掩码。
>- 若一个路由器连接在两个子网上，就拥有两个网络地址和两个子网掩码。

{% note primary %}
以上路由器行为是为了保证在传递IP数据报时，能够选择最符合的端口转发数据。todo？
{% endnote %}

## 无分类编址的IPv4地址
**无分类域间路由选择 CIDR** (*Classless Inter-Domain Routing*)。
- CIDR消除了A、B、C类地址和划分子网的概念。
- CIDR能更有效的分配IPv4的地址空间。

**特点**
- **IP 地址从三级编址（使用子网掩码）又回到了两级编址**。
- IP 地址的形式为：`a.b.c.d/x`，其中地址的 `x` 最高比特构成了 IP 地址的**网络部分（即网络前缀）**，所以 **CIDR 中 IP 地址由前缀和主机号构成**，`x` 为前缀长度，`/x` 的记法也称为**子网掩码**。

{% note primary %}
**CIDR**只是在网络实现层面消除了这些概念，并不代表A、B、C类地址和划分子网的协议行为不存在了。具体而言，总服务商分配到的公网IP地址基本仍为A、B、C类地址（如130.67.0.0/16），不过服务商可以把这些地址再划分下去给子服务商(如130.67.0.0/17和130.67.128.0/17)使用，我们也不再把这样的关系称为总网、子网关系。

问题：130.67.0.0/16 和130.67.0.0/17还是同一个目标IP地址吗？
答：这个问题本身就是错误的。
1. **IP地址仍然为一个全网唯一的IP地址**，并没有后面的网络前缀的区分。
2. 对于一个目标IP地址，**不会也不可能在数据传递时携带网络前缀**。
3. 在数据的传输中，**网络前缀只保存在路由器表中**，用于记录与路由器相连接的网络的所在的网络号。

问题：如果两个服务商，一个分到了`130.67.0.0/16`的公网IP，一个分到了`130.67.128.0/17`的公网IP，此时服务商1内部划分出子网`130.67.128.0/17`，其是否会与服务商2的IP在公网上重复？
答：不会。如上面所说，IP地址在分配时仍有等级之分，服务商一般只会分到`/8`，`/16`，`/24`这样的网络前缀，像`/17`这样的IP和网络前缀，本身就是由服务商1分发出来的，不可能由服务商2获得。
{% endnote %}

### 路由聚合
**超网（路由聚合）技术是为了解决路由表的内容冗余问题，使用路由聚合能够缩小路由表的规模，减少路由表的内存。**

即路由器发现其某个端口与多个具有相同前缀的网络对应，会将这些记录合并。

> 举个例子，如果路由器1与路由器2连接，路由器2的各个端口连接了不同的网络（本质上是多个子网）。
> 经过路由器交换学习，路由器1会得知路由器2所在网络号和网络前缀，而路由器2的不同接口在不同的网络号中，因此路由器1学习到了路由器2的多个网络。（如`67.67.0.0/18`，`67.67.64/18`, `67.67.128.0/18`,`67.67.192.0/18`)
> 此时，路由器1发现虽然有多个网络，但他们都对应着同一个端口，并且具有相同前缀（`67.67.0.0/16`）。此时路由器1会将这些记录合并，这种行为叫做路由聚合，也叫构造超网。

### 最长匹配原则
最长匹配 是指存在多条目的网段相同的路由时，匹配掩码最长的那一条。因为掩码越长，表示的网段就越小，匹配也就越精确。

{% note primary %}
条件：
- 路由器1：外部路由器。
- 路由器2：连接多个网段（子网）路由器。
- 路由器3：连接路由器2的一个子网路由器。
- 网段3：路由器3所在的网络。
- 3个路由器两两相连。
对于划分子网的IPv4地址，同一网络号的不同子网的记录只保存在该网络的中转的路由器2中。对于路由器1，其只需要知道路由器2的总网络号即可，其子网的划分对路由器1是**屏蔽的**。

但CIDR不再区分子网，路由器1会学习与之相连接的路由器2的所有网络号（IP和网络前缀）。这导致路由器2所在的子网对路由器1也是**可见的**，因此需要将这些网络号在本路由器的路由表中聚合起来，避免路由表内存浪费。

至于最长匹配原则，则可以当某个数据包要从路由器1要发往子网3。此时路由器1会优先匹配到最长的网段3，并将数据转发到路由器3。
{% endnote %}

![](routeUnion.png)

 ## 应用规划
 - 定长的子网掩码FLSM（*Fixed Length Subnet Mask*）
 - 变长的子网掩码VLSM（*Variable Length Subnet Mask*）
>前者就是分类IP，后者就是无分类IP
>定长的子网掩码只能划分出2^n个子网，而变长的子网掩码可以按需分配，减少对IP地址的浪费。

# 四、IP数据包的发送和转发过程

源主机如何知道目的主机是否与自己在同一个网络中，是直接交付，还是间接交付？

>可以通过**目的地址IP**和**源地址的子网掩码**进行**逻辑与运算**得到**目的网络地址**
>- 如果**目的网络地址**和**源网络地址** **相同**，就是**在同一个网络**中，属于**直接交付**
>- 如果**目的网络地址**和**源网络地址** **不相同**，就**不在同一个网络**中，属于**间接交付**，传输给主机所在网络的**默认网关**,由默认网关帮忙转发
>- 为了让本网络中的主机能和其他网络中的主机进行通信，就必须给其指定本网络的一个路由器的接口，由该路由器帮忙进行转发，所指定的路由器，也被称为**默认网关**。（具体地，默认网关指的是与本机网络直接相连的路由器**接口**，即下图中的0。通俗的讲，默认网关就是本网络与外网的默认接口）

![](24878825-0351946f5505b37a.webp)

{% note primary %}
前提：
- 本机IP ＆ 本机掩码 = 本机网络
- 目的IP ＆ 目的掩码 = 目的网络

正向来看：
如果：目的网络 == 本机网络（即目的掩码 = 本机掩码）
那么：目的IP ＆ 本机掩码 == 本机网络（目的网络）

反向来看：
条件：目的IP ＆ 本机掩码 == 本机网络
问题：目的网络是否为本机网络呢？
答案：**是**。考虑这个问题的时候主要在想以下情形：
”如果目的网络（`190.68.16.128/25`）是本机网络（`190.68.16.0/24`）的子网，那么上面条件是成立的，但该子网和该网络并不能划等号。“
但实际上这个想法本质就是错误的，在**CIDR和变长的子网掩码**中：
1. IP网络之间的关系已经没有了父子关系，
2. 对于变长子网掩码，不同的子网之间的关系依然是并列的。也就是说，如果本机IP的网络会被划分成（`190.68.16.0/24`），就说明已经有一个网段包含了`190.68.16.xxx`的所有主机，`190.68.16.128/25`网络根本就不可能存在，即若有某主机IP为`190.68.16.129`，其子网掩码也一定是`/24`。

以上证明了可以根据本机掩码和目的IP判断目的网络是否为本机网络，但如果不是本机网络，则不能直接判断目的网络的具体掩码长度，不过对于本机而言，只需要操心一个IP是由自己直接交付（本机网络）还是交给路由器（外网网络）处理即可。
{% endnote %}

## 路由器行为
1. 检查IP数据报首部是否出错
    - 若出错，则直接丢弃该IP数据报并通告源主机
    - 若没有出错，则进行转发
2. 根据IP数据报的目的地址在路由表中查找匹配的条目：
    - 若找到匹配的条目，则转发给条目中指示的吓一跳
    - 若找不到，则丢弃该数据报并通告源主机

## 路由选择协议
### 静态路由配置
#### 概念
静态路由配置指用户或网络管理员使用路由器的相关命令给路由**人工配置路由表**。

**默认路由**
默认路由可以被所有网络匹配，但路由匹配有优先级，默认路由是**优先级最低**的。一般为0.0.0.0/0(可以匹配所有地址)

**特定主机路由**
给路由器添加的针对某个主机的特定主机路由条目，可以指定其下一条目的。一般用于网络管理人员对网络的管理和测试。

{% note primary %}
当多条路由可选时，使用最长匹配原则。
{% endnote %}

**静态路由配置**其可能出现以下导致产生**路由环路**的错误。
- **配置错误**（手动配置错误）
- **聚合了不存在的网络**（解决办法：黑洞路由）
![](24878825-caeddc52bde20f9c.webp)
- **网络故障**（解决方法：为故障网路添加黑洞路由，故障恢复后使该黑洞路由失效）
![](24878825-d8107f8fc71dd1f4.webp)

## 动态路由选择
### 概念
**动态路由选择**相比**静态路由选择**能更好适应网络状态的变化，且适用于大规模网络。其路由器通过路由选择协议自动获取路由信息。

>**因特网采用分层次的路由选择协议**

**自治系统 AS**：在单一的技术管理下的一组路由器。自治系统之间的路由选择简称为域间路由选择，自治系统内部的路由选择简称为域内路由选择。
![](24878825-9e37d1229ec7836e.webp)

**路由选择协议**：域间路由选择使用外部网关协议**EGP**这个类别的路由选择协议，域内路由选择使用内部网关协议**IGP**这个类别的路由选择协议。**网关协议**的名称可称为**路由协议**。
![](24878825-8729bdd2bd367edf.webp)

{% note primary %}
**路由选择协议**的本质是路由器之间交换信息、判断某网络是否可达并进行路径选择的规则。由于路由器之间交换信息需要进行广播行为，由于路由表容量有限和避免广播的泛滥，需要使用**自治系统**来隔离网络中的路由器，并保证**同一个自治系统中使用同一种内部网关协议。自治系统之间则使用外部网关协议。**
{% endnote %}

### 常见的路由选择协议
![](24878825-6b1876963d6d9de0.webp)

### 路由器基本结构和功能
![](24878825-e6b69c1f176e24c5.webp)

**分组转发部分**
转发时需要注意的行为：
- 若在转发表中找不到匹配条目则**丢弃分组**
- 转发时会**更新分组首部的某些字段**，如分组生存时间
- 各端口都有缓冲区，每个端口一般都具有输入、输出功能

**路由选择部分**
路由选择处理器根据所使用的路由选择协议周期性的与其他路由器进行路由信息交互来更新路由表。
如果路由器接受到的分组是路由器之间交换路由信息的**路由报文**，则会把这种分组送交给**路由选择处理器**进行处理。

路由选择处理器的行为：
- 路由表一般只包含从目的网络到下一条的映射
- 路由表需要对网络拓扑变化的计算最优化
- 转发表是由路由表生成的
- 转发表的结构应当使查找过程最优化

{% note primary %}
路由表（RIB）和转发表（FIB）的联系和区别：
- 联系
转发表是路由器使用一个特定的进程通过路由表中的信息和自身的网卡等信息综合得到的。转发表类似于交换机的地址信息表。

- 区别
首先，"转发"和"路由选择"是有区别的，"转发"时，路由器只需要把接受到的信息从合适的端口发送出去即可，只涉及到一个路由器。"路由选择"则是许多路由器协同工作的结果。
其次，路由表只存储三元素：目标，掩码，下一跳；而转发表存储更详细的信息：比如输出端口信息，某些MAC地址，比如标记信息等。

这里的描述都屏蔽了MAC地址的问题，这里在汇总对比一下：
- MAC表：记录MAC地址和端口之间的映射关系
- ARP表：记录IP地址和MAC地址之间的映射关系
- 路由表：记录IP地址与IP地址之间的关系和路径代价。
举例：
局域网：使用MAC表和ARP表即可实现局域网内主机通讯（使用交换机，虽然现在不会这么使用）
主机流程：目的IP地址 -> 目的MAC地址 ->端口
路由器流程同上。

因特网：但不同网段之间的通讯，要涉及到网络路线选择问题。
主机流程：目的IP地址(非本网段) -> 目的MAC地址（默认网关）->端口
路由器流程：目的IP地址 -> 下一跳IP地址（路由选择） ->MAC地址 -> 端口
{% endnote %}

### 路由信息协议RIP
路由信息协议RIP(*Routing Information Protocol*)
![](24878825-850c29aaf1e744d6.webp)
#### 具体实现
**思路**
- 距离最短为最好路由
- 相同距离则负载均衡
- **只和相邻的路由器周期性的交换自己的路由表**

##### 基本工作过程
![](24878825-6bf4e045a90846e0.webp)

**路由更新细节**
接受到更新报文后和自己的路由器对比：
- 未知的Net，插入新信息。
- 相同Net和相同下一跳，**覆盖距离信息**。
- 相同Net和不同下一跳，距离不同则使用，若**相等则都保留并负载均衡**。

#### RIP存在的问题
如果网络出现故障，由于远处的路由器获知这个消息慢，先发出了自己的更新报文，则可能造成路由器之间互相认为对方可以到达一个不可达的网络，形成**网络环路**。

解决方法
![](24878825-3a055002b79a9cda.webp)

>但是，这些方法也不能完全解决“坏消息传播得慢”的问题，这是距离向量的本质决定

#### RIP的优缺点
>RIP 协议的优缺点
>优点：
>1. 实现简单，开销较小。
>缺点：
>1. RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）。
>2. 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。
>3. 坏消息传播得慢”，使更新过程的收敛时间过长。

### 开放最短路径优先OSPF
开放最短路径优先 OSPF (*Open Shortest Path First*)。
![](24878825-f5dc77f36b5b1047.webp)

#### 具体实现
##### OSPF五种分组类型
![](24878825-a2a83ab2654e270f.webp)

##### 基本工作过程
![](24878825-339786779f0e1a82.webp)

部分细节：
**Hello分组**
建立并维护路由器关系的分组。
![](24878825-f9c642e76e871651.webp)
>IP数据报首部中协议号字段的取值应为89，来表明IP数据报的数据载荷为OSPF分组

**发送链路状态通告LSA**
包含具体的路由信息，被封装在**LSU分组**中
![](24878825-bbed8a0d31bf19c3.webp)
>洪泛法有点类似于广播，就是从一个接口进来，从其他剩余所有接口出去

**链路状态数据库同步**
![](24878825-6b8e10e2d82cfa6f.webp)

**使用SPF算法计算出各自路由器到达其他路由器的最短路径**
![](24878825-4239eee0b6040f52.webp)

{% note primary %}
总结，OSPF是一个路由器通过获取AS内所有路由器之间边信息，然后建立一个以自己为根节点的无环图的过程。
具体地，相邻路由器会通过Hello分组维护关系，并互相简单介绍自己已知的路由信息，然后各自通过路由信息请求、路由信息返回、路由信息确认等过程逐步获得整个AS内的路由信息，最后构建各自的路由表。
{% endnote %}

#### OSPF存在的问题
##### 大量多播分组
多点接入（较多路由器互联）时，会产生大量的多播分组，通讯量过大。
**解决方法**
1）屏蔽部分路径，因此只与部分路由器进行数据交换。DR出现问题后使用BDR替换。

 2）路由分区，**为了使OSPF能够用于规模很大的网络，OSPF把一个自治系统再划分为若干个更小的范围，叫做区域（Area）**
![](24878825-725b3aab5aa350b1.webp)

>实现细节：
>- 在该自治系统内，所有路由器都使用OSPF协议，OSPF将该自治系统再划分成4个更小的区域，每个区域都有一个32比特的区域标识符，主干区域的区域标识符必须为0，主干区域用于连通其他区域，其他区域的区域标识符不能为0且不相同。
>- 每个区域一般不应包含路由器超过200个。
>- 划分区域的好处就是，利用洪泛法交换链路状态信息局限于每一个区域而不是自治系统，这样减少整个网络上的通信量。

#### OSPF的优缺点
{% note primary %}
优点：
- 从算法上避免了环路的产生。
- 基于链路状态，相比RIP考虑了更多对链路代价的影响因素。
- 不限制网络规模（没有最长距离限制）

缺点：
- 实现较复杂。
- 路由器需要获取AS内所有路由器信息，通信量大，可以通过**指定路由器**和**划分区域**的手段解决。
{% endnote %}

### 边界网关协议BGP
BGP（*Border Gateway Protocol*） 是**不同自治系统的路由器之间**交换路由信息的协议

**为何需要BGP？**
AS之间没有统一度量，且需要一个网关去解决AS之间通讯时的相关策略问题（政治、经纪、安全等），因此需要一个外部网关协议。
![](24878825-5aae9c53795e17a7.webp)

#### 具体实现
![](24878825-04fe6f98036db57c.webp)
![](24878825-bc71c2ee5976ac53.webp)
![](24878825-b472dd1a51f30666.webp)
##### BGP-4四种分组类型
![](24878825-67b837e6c27d5e9c.webp)

{% note primary %}
总结，BGP协议要求每个AS有一个发言人，发言人之间建立TCP连接建立会话，交换路由信息。类似于OSPF协议，发言人也会构造一个无环路的AS连通图。
注意，**BGP不保证最好路由，只选择较好路由**。
{% endnote %}

### 协议字段
![](24878825-40cf22cbd65e9ed8.webp)

# 五、IPv4数据包格式
## 首部格式
>- 一个 IP 数据报由**首部**和**数据**两部分组成。
>- **首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。**

![](24878825-73800cce52c3a91e.webp)

### 固定部分
**基本信息**
主要记录一些版本，服务约定，和后续数据长度。
- 版本：占4比特，目前最广泛的是4（IPv4）
- 首部长度：占4比特，该字段的取单位为**4个字节**（即上图的一行）。
	- 最小十进制取值为5，即20字节固定部分
	- 最大十进制取值为15，即20字节固定部分和40字节可变部分
- 区分服务：占8比特，需要区分服务（不同等级的服务质量）时才起作用，一般不适用该字段。
- 总长度：占16比特，表示**单位为字节**的IP数据报总长度（包括首部长度）。最大值为65535，即2^16-1

**分片信息**
主要用于IP数据报分片
![](24878825-a014cde6b0ff9691.webp)
- 标识：占16比特，同一个IP数据包的分片应该有同一个标识，类似IP
- 标志：占3比特：
	- DF位：1个比特，1表示不允许分片；0表示允许分片。
	- MF位：1个比特，1表示不是最后一个分片，0表示是最后一个分片。
	- 保留位：1个比特。
- 片偏移：占13比特，表示分片数据包的“数据载荷部分”相比原数据报中的“数据载荷部分”偏移了多少。（**单位为8字节**，注意，由于这里的偏移量比特位小于总长比特位，为了完成表达必须使用更大的单位。）
![](24878825-5d538557f988dc41.webp)

**解析信息**
- 生存时间TTL：占8比特，以“跳数”为单位，每次路由器转发该IP数据包，TTL-1，若为0则丢弃。
- 协议：占8比特，指明IPv4数据包的数据部分向上交付给什么协议。
![](24878825-94a3b7c0b1f01488.webp)
- 首部检验和：占16比特，检测首部在传输过程中是否出现差错。比CRC检验码简单，被称为因特网检验和。（由于TTL、片偏移、标志等可能发生变化，每次路由器转发时都要重新计算该值，耗时太大，在IPv6中已经不再计算首部校验和）

**地址信息**
目的IP和源IP地址：各占32比特。


### 可变部分
- 可选字段：长度从1到40字节不等
- 填充字段：确保**首部长度为4字节**（呼应首部长度的单位是4个字节）的整数倍，使用全0填充。

## 网际控制报文协议ICMP
### 协议功能
- 确认IP包是否成功送达目标地址
- 通知在发送过程当中IP包被废弃的具体原因
- 改善网络设置等

{% note primary %}
简而言之，需要一个与路由器之间的协议来**监测数据的转发情况**。
{% endnote %}

![](24878825-8739d970a0300acc.webp)

>**ICMP报文会被封装到IP数据报中，但其不是高层协议，而是IP层的特殊协议（起控制作用，所以也叫网际控制报文协议ICMP）。**

### 报文格式
![](24878825-6a02675fccdc2958.webp)

### 报文类型
**终点不可达**
![](24878825-855edabd9c1e6298.webp)
**源点抑制**
![](24878825-e7f27ef6c93c9621.webp)
**时间超过**
![](24878825-49d82185c88813fe.webp)
**参数问题**
![](24878825-e2457fe1291c9bca.webp)
**改变路由（重定向）**
![](24878825-0ef50227f921ca79.webp)

**另外，不应发送ICMP差错报告报文情况**
![](24878825-a0c3a21bb04ede42.webp)

### 应用例子
#### 分组网间探测PING（*Packet InterNet Groper*）
![](24878825-75d7bc12ca942415.webp)

#### 跟踪路由（*traceroute*）
![](24878825-185af899d5e5a922.webp)
实现原理：
使用从1开始递增的TTL发送多个报文，报文在路由器超时时会返回给源主机ICMP差错报告，从而得到各跳的信息。

# 六、虚拟专用网VPN与网络地址转换NAT
## 虚拟专用网VPN（*Virtual Private Network*）
### 介绍
**虚拟专用网络**VPN的功能是：在公用网络上建立专用网络，进行加密通讯。在企业网络中有广泛应用。VPN网关通过对数据包的加密和数据包目标地址的转换实现远程访问。

{% note primary %}
顾名思义，指一种利用公网实现专用网访问的技术。

简单的说就是两个专用网络之间通过公网IP进行加密通讯。VPN属于远程访问技术，简单地说就是利用公用网络架设专用网络。例如某公司员工出差到外地，他想访问企业内网的服务器资源，这种访问就属于远程访问。
{% endnote %}

![](24878825-ad9e5dcca8c0a1c9.webp)

数据报在因特网中可能要经过多个网络和路由器，但从逻辑上看，R1和R2之间好像是一条直通的点对点链路，因此也被称为IP隧道技术。
### 场景
![](24878825-6731dbc8b1ee1abc.webp)

## 网络地址转换NAT（*Network Address Translation*）
### 介绍
目的：大量的办公室网络和家庭网络导致IP地址仍然不够，需要实现IP复用。NAT能使大量**使用内部专用地址的用户共享少量外部全球地址来访问因特网上的主机和资源。**

专有NAT软件的路由器叫做NAT路由器，其有至少一个公网IP地址。

以上只解决了发送信息的问题，为了实现接受消息后的对内网用户的分发需要使用NAPT技术，具体见以下实现。

### 实现
![](24878825-05d3e1e3fd4b1998.webp)
### 注意
- 外网无法直接访问内网
![](24878825-d2fd109d060e4853.webp)
- NAT对内网主机提供了一定的安全保护
![](24878825-ff43ea52e61da271.webp)
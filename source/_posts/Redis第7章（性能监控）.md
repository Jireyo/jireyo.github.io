---
title: Redis第7章（性能监控）
categories:
 - [八股,Redis,基础]
date: 2023-01-06 18:32:37
tag:
 - Redis
 - 八股
---
# 状态命令
- 状态信息 - `info`
通过`info`命令查看实时吞吐量（ops/sec）。
- 监控执行命令 - `monitor`
监控接受到的命令
- 监控延迟 - `latency`
测量响应延迟
```shell
redis-cli --latency -h 127.0.0.1
```
- 内部机制监控
```shell
>CONFIG SET latency-monitor-threshold 100 #100是阈值，只有慢于100ms的才记录
>latency latest #查看最后一条消息的延迟

```

# 性能调优
## 避免使用过于复杂的命令
可以查看slowlog，查看执行慢的命令。
## 操作BigKey
如果value过大，分配内存会比较耗时。
可以通过`--bigkeys`命令扫描
### 解决
- 避免使用bigkey
- 4.0版本以下，使用unlink代替del
- 6.0版本以上，开启lazy-free机制
{% note primary %}
unlink和lazy-free都可以把释放内存放在后台线程中执行。
{% endnote %}

## 集中过期
### 解决
- 随机过期时间
- lazy-free

## 内存达到上限（max-memory）
### 解决
- 改成allkeys随机淘汰
- 拆分实例

## fork耗时严重
### 解决
- 控制内存大小（fork与实例大小有关）
- 合理配置持久化策略

## 开启内存大页
我们都知道，应用程序向操作系统申请内存时，是按内存页进行申请的，而常规的内存页大小是 4KB。
Linux 内核从 2.6.38 开始，支持了内存大页机制，该机制允许应用程序以 2MB 大小为单位，向操作系统申请内存。
应用程序每次向操作系统申请的内存单位变大了，但这也意味着申请内存的耗时变长。
### 解决
关闭内存大页机制

## AOF
- 写磁盘的瓶颈
- 子线程将aof刷入盘中的过程如果阻塞也会影响主线程写aof

一般下面一种情况发生在：
- 正在重写aof
- 其他应用程序大量占用磁盘IO

### 解决
配置中
```
no-appendfsync-on-rewrite yes
```
禁止了重写时的同步磁盘

## 绑定CPU
避免了上下文切换，但Redis有子进程，子进程若大量占用被绑定的CPU，会导致主进程受阻。

### 解决
若一定要绑定，可绑定到多个CPU上，Redis6.0已经支持各线程分别绑定CPU

## 使用Swap
如果你对操作系统有些了解，就会知道操作系统为了缓解内存不足对应用程序的影响，允许把一部分内存中的数据换到磁盘上，以达到应用程序对内存使用的缓冲，这些内存数据被换到磁盘上的区域，就是 Swap。

### 解决
- 增加内存
- 整理内存

## 碎片整理
碎片内存会降低使用效率
### 解决
整理内存也CPU资源，需要谨慎

## 网络带宽过载
### 解决
网络IO瓶颈，需要及时扩容。
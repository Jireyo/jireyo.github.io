---
title: 计算机网络-基础篇
categories: 
 - [八股,计算机网络,进阶]
date: 2022-12-09 23:04:35
tag: 
 - 计算机网络
 - 八股
---

#  一、TCP/IP网络模型

主要针对TCP/IP网络模型。

## 应用层

**应用层**（*Application Layer*）只专注于提供应用功能，比如 HTTP、FTP、Telnet、DNS、SMTP等。

应用层是工作在操作系统中的用户态，传输层及以下则工作在内核态。

## 传输层

应用层的数据包会传给传输层，**传输层**（*Transport Layer*）是为应用层提供网络支持的。

![传输层](应用层.png)

传输层会有两个传输协议，分别是 TCP 和 UDP。

**TCP** 的全称叫传输控制协议（*Transmission Control Protocol*），大部分应用使用的正是 TCP 传输层协议，比如 HTTP 应用层协议。TCP 相比 UDP 多了很多特性，比如流量控制、超时重传、拥塞控制等，这些都是为了保证数据包能可靠地传输给对方。

**UDP** 只负责发送数据包，不保证数据包是否能抵达对方。但它实时性相对更好，传输效率也高。当然，UDP 也可以实现可靠传输，把 TCP 的特性在应用层上实现就可以，不过要实现一个商用的可靠 UDP 传输协议，也不是一件简单的事情。

### 应用层与传输层的交互

应用需要传输的数据可能会非常大，因此当传输层的数据包大小超过 MSS（TCP 最大报文段长度），就要将数据包分块，这样即使中途有一个分块丢失或损坏了，只需要重新发送这一个分块，而不用重新发送整个数据包。在 TCP 协议中，我们把每个分块称为一个 **TCP 段**（*TCP Segment*）。

![TCP段](TCP段.png)



传输层其实并不负责整个传输过程，它的作用是相对应用层而言的，即它可以帮助应用层实现数据传输。

到传输层数据到达目标设备时，传输层则要负责把数据包传给应用，但一台设备有多个应用，这时需要使用端口号将应用区分开来。对于浏览器（客户端）中的每个标签栏都是一个独立的进程，操作系统会为这些进程分配临时的端口号。传输层报文中携带端口号，因此可以识别数据要发给哪个应用。

## 网络层

如上所述，传输层其实主要做区分应用，把应用数据下发的作用，真正使数据在互联网上传输的功能在**网络层**（*Internet Layer*）上。

![网络层](网络层.png)

网络层最常使用的是 IP 协议（*Internet Protocol*），IP 协议会将传输层的报文作为数据部分，再加上 IP 包头组装成 IP 报文，如果 IP 报文大小超过 MTU（以太网中一般为 1500 字节）就会**再次进行分片**，得到一个即将发送到网络的 IP 报文。

![MAC](12.jpg)

### IP地址

对于 IPv4 协议， IP 地址共 32 位，分成了四段（比如，192.168.100.1），每段是 8 位。

将IP 地址分成两种意义：

- 一个是**网络号**，负责标识该 IP 地址是属于哪个「子网」的；
- 一个是**主机号**，负责标识同一「子网」下的不同主机；

配合**子网掩码**，可以将一个网络号同时给多个主机使用，子网掩码则用于计算 网络号和主机号。

如10.100.122.0/24后面的`/24`表示就是 `255.255.255.0`，将IP地址与子网掩码按位与，得到网络号，与子网掩码的取反按位与，则得到主机号。

寻找目标地址的过程，就是一个寻找网络->寻找主机的过程。

**IP 协议的寻址作用是告诉我们去往下一个目的地该朝哪个方向走，路由则是根据「下一个目的地」选择路径。寻址更像在导航，路由更像在操作方向盘**。

## 网路接口层

生成了 IP 头部之后，接下来要交给**网络接口层**（*Link Layer*）在 IP 头部的前面加上 MAC 头部，并封装成数据帧（Data frame）发送到网络上。

![网络接口层](网络接口层.png)

网络层实现了信息在互联网上传输的功能，而要将信息传输到互联网，我们还需要经过网络接口层。

网络接口层的功能主要体现在以太网技术上，即通过局域网把网络包发送到目的地。

MAC 头部是以太网使用的头部，它包含了接收方和发送方的 MAC 地址等信息，我们可以通过 ARP 协议获取对方的 MAC 地址。

所以说，网络接口层主要为网络层提供「链路级别」传输的服务。个人理解是在数据的传输中，数据包会经过很多交换机，交换机会将数据包解包至网络接口层，然后再封装，发送。

### MAC地址

使用 MAC 地址，我们可以标识网络上的设备，实现在以太网、WiFi 这样的底层网络上发送原始数据包。

## 总结

综上所述，TCP/IP 网络通常是由上到下分成 4 层，分别是**应用层，传输层，网络层和网络接口层**。

![tcpip参考模型](tcpip参考模型.drawio.png)

封装格式：

![封装](封装.png)

{% note info %}
网络接口层的传输单位是帧（frame），IP 层的传输单位是包（packet），TCP 层的传输单位是段（segment），HTTP 的传输单位则是消息或报文（message）。但这些名词并没有什么本质的区分，可以统称为数据包。
{% endnote %}

>应用层负责将应用产生的数据传递给传输层，将从传输层接受到的数据组合，返回给应用。
>
>传输层负责将从应用层接受到的数据包传递给网络层，这个过程会携带应用端口
>
>网络层负责将从传输层接受到的数据包发送到网络，这个过程会携带IP地址（网络号+主机号/子网掩码）
>
>网络接口层负责将网络层的数据通过以太网技术的方式发送到数据库

# 二、浏览器请求过程
![](2.webp)
## HTTP
### 1.解析URL
浏览器先解析URL地址，然后生成给WEB服务器的信息。
![](3.webp)
如果省略资源路径，则会访问Web服务根目录的`index.html`或`default.html`

### 2.生成HTTP请求信息

![](4.webp)
{% note primary %}
HTTP报文三要素：
- 请求报文：请求行(req)+请求头(head)+请求体(body)
- 响应报文：状态行(status)+消息头(head)+消息体(body)
{% endnote %}

## DNS
消息发送前需要**查询服务器域名对应的 IP 地址**
因为委托操作系统发送消息时，必须提供通信对象的 IP 地址。

### 概念
DNS是一种服务器，其专门保存了 `Web` 服务器域名与 `IP` 的对应关系。
DNS 中的域名都是用**句点**来分隔的，比如 `www.server.com`，这里的句点代表了不同层次之间的**界限**。
在域名中，**越靠右**的位置表示其层级**越高**，这与中文相反。

实际上域名最后还有一个点，比如 `www.server.com.`，这个最后的一个点代表根域名。即`.` 根域是在最顶层，它的下一层就是 `.com` 顶级域，再下面是 `server.com`

所以实际上是 .  --> .com -->server
![](5.webp)

### 运行
根域的 DNS 服务器信息保存在互联网中所有的 DNS 服务器中。这样任何 DNS 服务器就都可以找到并访问根域 DNS 服务器了。因此，客户端只要能够找到任意一台 DNS 服务器，就可以通过它找到根域 DNS 服务器，然后再一路顺藤摸瓜找到位于下层的某台目标 DNS 服务器。

也就是说，查询域名IP时：
1. 客户端只会向最近的本地DNS服务器请求ip地址。
2. 本地DNS服务器若记录了ip地址，则直接返回，若没有记录，则进行以下操作。
3. 本地DNS向根DNS服务器请求ip地址，根DNS将.com的DNS服务器给本地DNS服务器。
4. 本地DNS服务器再向.com的DNS（顶级域名服务器）请求ip地址，顶级域名服务器将www.server.com的权威 DNS 服务器给本地DNS服务器。
5. 权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。
6. 本地 DNS 再将 IP 地址返回客户端，然后客户端和目标建立连接。

{% note warning %}
根域名服务器是最高层次的，它不直接用于域名解析，但能指明目标服务器的位置。
{% endnote %}

![](6.webp)

>DNS 域名解析的过程是一个**只指路不带路**的过程。

{% note primary %}
当然，浏览器、操作系统、hosts文件都有缓存，在这些地方都找不到时才会向本地DNS服务器发请求。
{% endnote %}

## 协议栈
通过 DNS 获取到 IP 后，就可以把 HTTP 的传输工作交给操作系统中的**协议栈**。

{% note primary %}
注意这里开始进入操作系统层面。
{% endnote %}

协议栈的内部分为几个部分，分别承担不同的工作。上下关系是有一定的规则的，上面的部分会向下面的部分委托工作，下面的部分收到委托的工作并执行。

![](7.webp)

应用程序（浏览器）通过调用 Socket 库，来委托协议栈工作。

协议栈的上半部分有两块，分别是负责收发数据的 TCP 和 UDP 协议，这两个传输协议会接受应用层的委托执行收发数据的操作。

协议栈的下面一半是用 IP 协议控制网络包收发操作，在互联网上传数据时，数据会被切分成一块块的网络包，而将网络包发送给对方的操作就是由 IP 负责的。

此外 IP 中还包括 `ICMP` 协议和 `ARP` 协议。

-   `ICMP` 用于告知网络包传送过程中产生的错误以及各种控制信息。
-   `ARP` 用于根据 IP 地址查询相应的以太网 MAC 地址。

IP 下面的网卡驱动程序负责控制网卡硬件，而最下面的网卡则负责完成实际的收发操作，也就是对网线中的信号执行发送和接收操作。

进入协议栈后，就依靠各层协议一步一步完成数据传输。 

## TCP

HTTP 是**基于 TCP 协议**传输的，TCP报文格式如下：
![TCP报文](8.webp)

理解：
- **源端口号**和**目标端口**号：这是与应用层交互的关键识别信息。
- 包**序**号，防止乱序
- **确认号**，防止丢包
- **状态位**。例如 `SYN` 是发起一个连接，`ACK` 是回复，`RST` 是重新连接，`FIN` 是结束连接等。TCP 是面向连接的，因而双方要维护连接的状态，这些带状态位的包的发送，会引起双方的状态变更。
- **窗口大小**：TCP 要做**流量控制**，通信双方各声明一个窗口（缓存大小），标识自己当前能够的处理能力，从而实现**拥塞控制**：即控制发送的速度。

### TCP三次握手
所谓的握手就是使通讯双方维护一个状态机。
![](TCP三次握手.drawio.webp)

>SYN指**SYN：同步序列编号**（ Synchronize Sequence Numbers ）
>ACK指**ACK：确认字符**（Acknowledge character）

{% note success %}
三次握手目的是**保证双方都有发送和接收的能力**。
{% endnote %}

{% note primary %}
TCP 的连接状态查看，在 Linux 可以通过 `netstat -napt` 命令查看。
{% endnote %}

### TCP数据分割
若HTTP请求报文较长，超过了 `MSS` 的长度则需要拆解。
![](11.webp)

- `MTU`：一个网络包的最大长度，以太网中一般为 `1500` 字节。
- `MSS`：除去 IP 和 TCP 头部之后，一个网络包所能容纳的 TCP 数据的最大长度。

![](12.webp)

拆分出来的每一块数据都会被放进单独的网络包中，分别加上 TCP 头信息，然后交给 IP 模块来发送数据。

### TCP报文生成
	
todo:
TCP报文生成
https://cloud.tencent.com/developer/article/1875682#:~:text=%E5%BD%93%E8%B7%AF%E7%94%B1%E5%99%A8%E6%94%B6%E5%88%B0%E4%B8%80%E4%B8%AAIP%E6%95%B0%E6%8D%AE%E5%8C%85%E6%97%B6%EF%BC%8C%E8%B7%AF%E7%94%B1%E5%99%A8%E4%BC%9A%E8%A7%A3%E6%9E%90%E5%87%BAIP%E6%95%B0%E6%8D%AE%E5%8C%85%E4%B8%AD%E7%9A%84%20%E7%9B%AE%E7%9A%84IP%E5%9C%B0%E5%9D%80%20%EF%BC%8C%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E7%9B%AE%E7%9A%84IP%E5%9C%B0%E5%9D%80%E6%9F%A5%E6%89%BE%E8%B7%AF%E7%94%B1%E8%A1%A8%EF%BC%8C%E4%BE%9D%E6%8D%AE,%E6%9C%80%E9%95%BF%E6%8E%A9%E7%A0%81%E5%8C%B9%E9%85%8D%E5%8E%9F%E5%88%99%20%EF%BC%8C%E6%89%BE%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84%E8%B7%AF%E7%94%B1%E6%9D%A1%E7%9B%AE%EF%BC%8C%E6%A0%B9%E6%8D%AE%E8%B7%AF%E7%94%B1%E6%9D%A1%E7%9B%AE%E4%B8%AD%E7%9A%84%E4%B8%8B%E4%B8%80%E8%B7%B3%E6%88%96%E8%80%85%E5%87%BA%E6%8E%A5%E5%8F%A3%E5%B0%86%E6%8A%A5%E6%96%87%E8%BD%AC%E5%8F%91%E5%87%BA%E5%8E%BB%EF%BC%8C%E8%BF%99%E5%B0%B1%E6%98%AF%20%E8%B7%AF%E7%94%B1%20%E3%80%82
https://mp.weixin.qq.com/s?__biz=MzIwOTcyNjA3Mw==&mid=2247500748&idx=1&sn=08b9a324a2c33a6c80e26a7711cfef96&chksm=976dfcdaa01a75ccc0cf85569f92ed3d0597bfaeac736a3a3114e0d34fac821b1c0458269fb9&scene=21#wechat_redirect
https://www.cnblogs.com/mefj/p/14543955.html#:~:text=%E4%B8%80%E3%80%81%E6%9C%80%E9%95%BF%E6%8E%A9%E7%A0%81%E5%8C%B9%E9%85%8D%E5%8E%9F%E5%88%99%20%E6%9C%80%E9%95%BF%E6%8E%A9%E7%A0%81%E9%80%89%E8%B7%AF%E5%8E%9F%E5%88%99%20%EF%BC%9A%E6%9C%89%E5%A4%9A%E6%9D%A1%E8%B7%AF%E7%94%B1%E9%83%BD%E8%83%BD%E5%8C%B9%E9%85%8D%E7%9B%AE%E7%9A%84%E5%9C%B0%E5%9D%80%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E9%80%89%E6%8B%A9%E5%85%B6%E4%B8%AD%E6%8E%A9%E7%A0%81%E6%9C%80%E9%95%BF%E7%9A%84%E8%B7%AF%E7%94%B1%20%E4%BE%8B%EF%BC%9A%E5%A6%82%E4%B8%8B%E5%BD%93%E6%9C%89%2F24%E5%92%8C%2F25%E4%BD%8D%E7%9A%84%E6%8E%A9%E7%A0%81%E9%83%BD%E8%83%BD%E5%8C%B9%E9%85%8D%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E8%BF%9B%E8%A1%8C%E6%9C%80%E9%95%BF%E6%8E%A9%E7%A0%81%E5%8C%B9%E9%85%8D%EF%BC%8C%E9%80%89%E6%8B%A9%2F25%E7%9A%84%E8%B7%AF%E7%94%B1%E6%8E%A5%E5%8F%A3E0%E3%80%82%20%E4%BA%8C%E3%80%81%20%E7%AE%A1%E7%90%86%E6%80%A7%E8%B7%9D%E7%A6%BB%20%28AD%29%E9%80%89%E8%B7%AF%E5%8E%9F%E5%88%99%20%E7%AE%A1%E7%90%86%E6%80%A7%E8%B7%9D%E7%A6%BB,%EF%BC%9A%E6%9C%89%E5%A4%9A%E6%9D%A1%E8%B7%AF%E7%94%B1%E9%83%BD%E8%83%BD%E5%8C%B9%E9%85%8D%E7%9B%AE%E7%9A%84%E5%9C%B0%E5%9D%80%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E4%B8%94%E8%BF%99%E6%97%B6%E5%80%99%E6%8E%A9%E7%A0%81%E4%B8%80%E6%A0%B7%20%28%E8%B7%B3%E8%BF%87%E6%9C%80%E9%95%BF%E6%8E%A9%E7%A0%81%E5%8C%B9%E9%85%8D%E5%8E%9F%E5%88%99%29%EF%BC%8C%E4%B8%94%E8%BF%99%E6%97%B6%E5%80%99%E7%AE%A1%E7%90%86%E6%80%A7%E8%B7%9D%E7%A6%BB%E4%B8%80%E6%A0%B7%20%28%E7%9B%B8%E5%90%8C%E5%8D%8F%E8%AE%AE%2C%E8%BF%99%E6%97%B6%E5%80%99%E8%B7%B3%E8%BF%87%E7%AE%A1%E7%90%86%E6%80%A7%E8%B7%9D%E7%A6%BB%20%28AD%29%E9%80%89%E8%B7%AF%E5%8E%9F%E5%88%99%29%E3%80%82%20%E5%9C%A8%E5%90%8C%E4%B8%80%E4%B8%AA%E5%8D%8F%E8%AE%AE%E5%86%85%E5%88%A4%E5%BA%A6%E9%87%8F%E5%80%BC%20%E6%80%BB%E7%BB%93%EF%BC%9A%20%E4%BD%9C%E8%80%85%EF%BC%9A%20%E8%BF%90%E7%BB%B4%E5%AF%86%E7%A0%81
https://bbs.huaweicloud.com/blogs/359221
https://zhuanlan.zhihu.com/p/61805945
https://www.cnblogs.com/liyuanhong/p/13585654.html

# 参考资料

[小林coding-图解网络](https://xiaolincoding.com/network/)
---
title: 计算机网络第5章（运输层）
categories:
 - [八股,计算机网络,基础]
date: 2022-12-28 20:48:03
tag: 
 - 计算机网络
 - 八股
---
# 一、概述
## 概念
进程之间通讯
![](24878825-86df51cb4523e3bf.webp)
- 从通信和信息处理的角度看，运输层向它上面的应用层提供通信服务，**它属于面向通信部分的最高层，同时也是用户功能中的最低层**。
- 当网络的边缘部分中的两个主机使用网络的核心部分的功能进行端到端的通信时，**只有位于网络边缘部分的主机的协议栈才有运输层**，而网络核心部分中的路由器在转发分组时都只用到三层（到网络层）的功能。

{% note primary %}
NAT虽然实现上涉及到了端口，但在规范中我们仍将其只视为网络层的协议。
{% endnote %}

之前介绍的物理层、数据链路层、网络层解决了主机到主机的通讯。但通讯的真正实体是位于通讯两端主机的进程，如何为这两个进程提供通讯服务是运输层的任务，运输层协议也被称为端到端协议。

## 端口号与复用
端口号的使用
![](24878825-de597eda77aa6acd.webp)

### 发送方与接受方的复用
![](24878825-2a4ec3f5d5c11433.webp)
>**多个进程（这里一个端口表示一个进程）** 利用一个运输层协议（或者称为运输层接口）**发送**数据称为 **复用**
>**多个进程（这里一个端口表示一个进程）** 利用一个运输层协议（或者称为运输层接口）**接收**时叫做 **分用**。

### 常用端口号
![](24878825-2117fa99a7f2a89c.webp)

# 二、运输层传输流程（DNS）
- DNS客户端（端口为短暂端口号）发送一个**DNS请求报文**（UDP）到DNS服务器（端口号为53）。
- DNS服务器将接受到的信息上传给DNS服务器端进程（端口号为53），随后给用户回复**DNS响应报文**（UDP），目的端口为客户端的短暂端口号。
- DNS客户端将接受到的信息上传给DNS客户端进程（端口号为短暂端口号），随后解析DNS响应报文，即可直到Web域名对应的IP地址。
- 向Web域名对应的IP发送http请求。

# 三、UDP与TCP对比
## 概念对比
- 两个对等运输实体在通信时传送的数据单位叫作**运输协议数据单元** TPDU (Transport Protocol Data Unit)。
- 当运输层采用面向连接的 **TCP** 协议时，尽管下面的网络是不可靠的（只提供尽最大努力服务），但这种逻辑通信信道就相当于一条**全双工的可靠信道**；当运输层采用无连接的 **UDP** 协议时，这种逻辑通信信道是一条**不可靠信道**。
- TCP 传送的数据单位协议是 **TCP 报文段**(segment)。；UDP 传送的数据单位协议是 **UDP 报文**或**用户数据报**。
- TCP是面向连接的，TCP之间的通信必须要在两个套接字（Socket）之间建立连接；UDP的通信是无连接的，不需要套接字（Socket）。

![](24878825-58c94f043969af9a.webp)

## UDP
结构
![](24878825-624005a24bc5bfcd.webp)
实现
- UDP可以**广播、多播和单播**
- UDP对应用进程交下来的报文**既不合并也不拆分**，而是保留这些报文的边界
- UDP向上层提供**无连接不可靠传输服务**

## TCP(Transmission Control Protocol)
结构
![](24878825-db48b70af7fb7884.webp)
实现
- TCP只支持单播，端对端通讯
- 需要先通过3次握手建立连接
- TCP是面向字节流的，即其**可能会拆分上层交付的报文**。
- TCP向上层提供**面向连接的可靠传输服务**

## 总结
![](24878825-b0c1d4146735458a.webp)

# 四、TCP流量控制
目的：发送的速率尽可能快，但需要接受方来得及接受。
实现：滑动窗口。
[具体流程视频](https://www.bilibili.com/video/BV1c4411d7jb/?p=60)

## 实现
累计确认+选择重传（只重传超时的，即每个窗口独立持有一个计时器）
1. 发送端和接受端分别具有发送窗口和接受窗口。发送端会将发送窗口内的字节数据依次发出。
2. 接受方通过累计确认提示发送端应该**如何调整发送窗口的大小**（流量控制）以及**已经接受到了n字节之前的数据**。
3. 发送方接受到累计确认后**调整发送窗口大小**并**移动发送窗口**。
4. 移动发送窗口后：
	- 将刚进入窗口的窗口信息发送出去
	- 同时等待看是否有窗口触发超时重传，若有则重传旧数据。
![](24878825-f73e94f75e94ea4c.webp)
5. 接受端将发送窗口调整为了0，说明暂时不接受数据，其恢复后给发送方的提示是可能丢失的。因此，**当发送窗口为0（接受到0窗口通知）时，**发送方**持有持续计时器，超时时会发送**零窗口探测报文**，确认接受端处理能力情况。
![](24878825-5bd53b8a5a5ac400.webp)
![](24878825-ea9dc3589e6c6bd1.webp)
## 总结
![](24878825-d8221e9dda7919f9.webp)

# 五、TCP拥塞控制
## 概念
![](24878825-9d4b410b2a44c125.webp)

**网络拥塞往往是由许多因素引起的。例如：**
1. 点缓存的容量太小；
2. 链路的容量不足；
3. 处理机处理的速率太慢；
4. 拥塞本身会进一步加剧拥塞；

{% note primary %}
理解拥塞原因：
1.传输时，链路容量不足；2.接受时，容量太小；3.处理时，速率太慢；4.负反馈。
{% endnote %}

**拥塞控制的一般原理**
1. 拥塞控制的前提：网络能够承受现有的网络负荷。
2. 实践证明，拥塞控制是很难设计的，因为它是一个**动态问题**。
3. 分组的丢失是网络发生拥塞的**征兆**而不是原因。
4. 在许多情况下，甚至正是**拥塞控制本身**成为引起网络性能恶化、甚至发生死锁的原因。

**开环控制和闭环控制**
![](24878825-2740d71c5e1d6aac.webp)

**监测网络的拥塞**
主要指标有：
1.  由于缺少缓存空间而被丢弃的分组的百分数；
2.  平均队列长度；
3.  超时重传的分组数；
4.  平均分组时延；
5.  分组时延的标准差，等等。

{% note primary %}
理解：
{% endnote %}

## 拥塞控制的算法
![](24878825-67852fc13fc0e263.webp)
![](24878825-c7682fe29ebcb6fd.webp)

>发送窗口大小 = min(接受方窗口大小，拥塞窗口大小)

### 慢开始和拥塞避免
- 目的：用来确定网络的负载能力或拥塞程度。
- 算法的思路：由小到大逐渐增大拥塞窗口数值。
- 两个变量：
	- **拥塞窗口（cwnd）**：初始拥塞窗口值有2 种设置方法。窗口值逐渐增大。第一种是1 至 2 个最大报文段 （旧标准）；第二种是2 至 4 个最大报文段 （RFC 5681）
	- **慢开始门限（ssthresh）**：防止拥塞窗口增长过大引起网络拥塞。

- 实现：
	- 起初拥塞窗口按指数增加，当达到慢开始门限后，为了避免出现拥塞，每经过一个传输伦次，cwnd++
	- 如果出现超时重传，则重新回到慢开始
![](24878825-f5db7ea25d8aca73.webp)

{% note primary %}
慢开始是为了从小到大且尽快的达到门限，门限后则缓慢的扩大拥塞窗口来试探网络情况，两者一起使用以实现动态调整拥塞窗口。
{% endnote %}

{% note warning %}
注意：这里是拥塞窗口的变化，而不是发送窗口的变化，发送窗口的大小还受限于接受端的接受窗口。
{% endnote %}

### 快重传（*fast retrasmit*）与快恢复（*fast recovery*）
![](24878825-a57c7cc819aa4bae.webp)

![](24878825-ab5a63efbd586eb8.webp)

{% note primary %}
一般接受方对接受到的报文段的确定都是捎带的，和窗口控制报文一起发送给发送端，导致重传开启较慢。
**快重传**：需要接受端尽快的回复接受到的报文信息，然后发送端实现快重出传（接受到连续3个重复的确认报文）

发送端发生重传时，直接进入慢开始，这对于仅丢失个别报文的传输的效率较大，而快重传刚好可以确定这类情况。
**快恢复**：当发送快重传时不进入慢开始，而是调节ssthresh值和cwnd值为一半后直接开始执行拥塞避免算法。

快恢复要和快重传结合使用，快恢复的具体调整依赖于发送端具体的实现。
{% endnote %}

![](24878825-8f61b8eddb5b2624.webp)

# 六、TCP超时重传时间的选择
不必要的重传会导致网络负荷的增大，但重传推迟的太久也会导致传输效率的降低。因此需要合理的设置超时重传时间*RTO*，其应该略大于往返时间*RTT*，具体计算：
## RTT
![](24878825-20d1cf6bb211fe7e.webp)
## RTO
![](24878825-39ab62874e65b623.webp)

{% note primary %}
RTT计算：越近的RTT样本权重越大。
RTO计算：在RTT的基础上加上了RTT的偏差。(相当于加上了RTTs与新样本的差异，β只是一个权重参数，RTT（D1） = RTT（1）/2只是数据的初始化）。
{% endnote %}

## 超时重传
![](24878825-dbc63525eab966e1.webp)

## 总结
![](24878825-c94fa8a3ad6b277f.webp)

# 七、TCP可靠传输的实现
![](24878825-6d10ea76a1ea032b.webp)
![](24878825-92d975bc880db892.webp)
![](24878825-35bff0a8cc5b0d71.webp)

{% note primary %}
发送方接收到确认消息后，需要1.前移2.调整窗口大小。
调整窗口大小时，原则上窗口的前沿是不推荐后移的，所以最好是通过 后沿前移+前沿不动 来实现窗口缩小。
{% endnote %}

{% note primary %}
接收方对数据的确认有累计确认和捎带确认：
- 累计确认要求接收方不要过迟的发送确认。
- 捎带确认使用较少。
{% endnote %}

# 八、TCP的运输连接管理
![](24878825-e7d2329746de8e6a.webp)
## TCP连接建立（握手）
### 概念
握手需要在客户和服务器之间交换三个 TCP 报文段。称之为**三报文握手**。
![](24878825-84c2b6dbb20379bd.webp)

{% note primary %}
**双报文握手**保证双方得知对方的存在，随后可以直接发送数据。
**三报文握手**主要是为了防止已失效的连接请求报文段突然又传送到了，因而产生错误，导致服务器资源浪费。
{% endnote %}
![两报文握手](24878825-0a5773a600817c41.webp)

### 过程
-   TCP 连接的建立**采用客户服务器方式**。
-   主动发起连接建立的应用进程叫做**TCP客户** (client)。
-   被动等待连接建立的应用进程叫做**TCP服务器** (server)。
![服务器打开传输控制块](24878825-e69d0e450b080e1f.webp)

>一开始，TCP服务器进程首先创建传输控制块，用来存储TCP连接中的一些重要信息。例如TCP连接表、指向发送和接收缓存的指针、指向重传队列的指针，当前的发送和接收序号等。
>之后，就准备接受TCP客户端进程的连接请求。
>此时，TCP服务器进程就进入监听状态，等待TCP客户端进程的连接请求。
>而TCP客户端在主动打开前也是要先创建传输控制块。

![](24878825-3205fd7d7d75b62e.webp)

{% note primary %}
**SYN**，**ACK**是TCP报文头中的一个bit，其标识了当前TCP报文的属性：
SYN（同步标志位）表示请求同步，ACK（确认标识位）表示是对某报文的回复。
**seq**，**ack**是TCP报文头中的两个字段，都占4个字节，其标识了端消息的id和确认收到的消息id+1。

TCP规定SYN=1的报文段即使不携带数据，也要消耗掉一个序号。
普通的确认报文可以不消耗序号。
{% endnote %}

## TCP连接释放（挥手）
### 概念
- TCP 连接的建立**采用客户服务器方式**。
- 主动发起连接建立的应用进程叫做**TCP客户** (client)。
- 被动等待连接建立的应用进程叫做**TCP服务器** (server)。
- **任何一方都可以在数据传送结束后发出连接释放的通知**

### 过程
![](24878825-1c5e0c6357d039ed.webp)

- 前两次握手是确认服务器接受到了释放连接的请求，此后服务器对剩余数据进行传输，客户端进入终止等待2状态。
- 后两次握手是确认客户端接受到了释放连接的命令，此后服务器关闭，客户端则继续等待2MSL，这是为了防止第四次握手丢失导致服务器资源浪费。若直接关闭：
![](24878825-ef85470fe120f146.webp)
- 若服务器没有收到第四次握手，则会重传第三次握手，以确保收到第四次握手。

{% note warning %}
第二次握手和第三次握手的ack序号相同，说明这个消息是对同一个消息（第一次握手）的回应，分别表示服务器收到释放连接请求和服务器运行释放连接请求。
{% endnote %}

{% note warning %}
可见握手和挥手，都需要客户端保证对服务器连接的最终确认以防止服务器的资源浪费。
在握手中体现在服务器之后接收到第三次握手确认在进入连接状态。
在挥手中体现在客户端会保持等待，服务器主动重传第三次握手以收到第四次握手。
{% endnote %}

{% note primary %}
**FIN**是TCP报文头中的一个bit，表示请求释放连接。在挥手中其会出现两次，一次是客户端主动请求释放连接，一次是服务器回复可以释放连接了。

TCP规定终止位FIN等于1的报文段即使不携带数据，也要消耗掉一个序号
{% endnote %}

## TCP保活计时器
TCP双方已经建立了连接，后来，TCP客户进程所在的主机突然出现了故障，TCP服务器进程以后就不能再收到TCP客户进程发来的数据，因此，应当有措施使TCP服务器进程不要再白白等待下去
![](24878825-2dc97e06fe1d82ed.webp)

# 九、TCP报文段的首部格式
![](24878825-df9263a14e1da2c1.webp)
## 固定首部
源端口和目的端口
![](24878825-27e4bd51d5db2f8e.webp)
序号、确认号和确认标志位
![](24878825-fd0e64d8be3f598b.webp)
数据偏移、保留、窗口和校验和
![](24878825-d3d4c61af68fdb6d.webp)
同步标志位、终止标志位、复位标志位、推送标志位、紧急标志位和紧急指针
![](24878825-f09bdaba863c4ca3.webp)
## 扩展首部
![](24878825-d1a8d3ca5ac7f39d.webp)
